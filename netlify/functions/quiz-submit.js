// ====================================
// QUIZ SUBMIT - PRODUCTION VERSION
// ====================================
// Webhook pro Business Health Quiz
// URL: /.netlify/functions/quiz-submit
// UPDATED: Using same pattern as fapi-webhook.js

// Supabase client helper
async function createSupabaseClient() {
  const { createClient } = await import('@supabase/supabase-js');
  return createClient(
    process.env.SUPABASE_URL,
    process.env.SUPABASE_ANON_KEY // âœ… SAME AS PAYMENT WEBHOOK
  );
}

// Resend email sending function
async function sendEmail(to, subject, html) {
  console.log('ğŸ“¨ Sending email via Resend to:', to);
  
  const response = await fetch('https://api.resend.com/emails', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${process.env.RESEND_API_KEY}`, // âœ… SAME AS PAYMENT WEBHOOK
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      from: 'PodnikatelskÃ¡ ÄŒtvrtka <kurz@podnikatelskactvrtka.cz>',
      to: [to],
      subject: subject,
      html: html,
    }),
  });
  
  console.log('ğŸ“§ Resend Response Status:', response.status);
  
  if (!response.ok) {
    const error = await response.text();
    console.error('âŒ Resend error:', error);
    throw new Error(`Email failed: ${error}`);
  }
  
  const data = await response.json();
  console.log(' Email sent via Resend:', data.id);
  return data;
}

// Main handler
export async function handler(event, context) {
  console.log('ğŸš€ quiz-submit function called');
  
  // Only accept POST requests
  if (event.httpMethod !== 'POST') {
    console.log('âŒ Wrong method:', event.httpMethod);
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method not allowed' })
    };
  }
  
  // Enable CORS
  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Access-Control-Allow-Methods': 'POST, OPTIONS',
    'Content-Type': 'application/json'
  };
  
  // Handle OPTIONS preflight request
  if (event.httpMethod === 'OPTIONS') {
    console.log('âœ… OPTIONS preflight');
    return {
      statusCode: 200,
      headers,
      body: ''
    };
  }
  
  try {
    console.log('ğŸ“¦ Raw event body:', event.body);
    const { email, name, quizType, answers, result } = JSON.parse(event.body);
    
    console.log('ğŸ“ Quiz submission:', { email, quizType, category: result.category, score: result.score });
    console.log('ğŸ“Š Full result object:', result);
    
    // Validate
    if (!email || !result) {
      console.error('âŒ Missing required fields');
      return {
        statusCode: 400,
        headers,
        body: JSON.stringify({ error: 'Missing required fields' })
      };
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ’¾ SAVE TO SUPABASE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('ğŸ’¾ Saving quiz results to Supabase...');
    const supabase = await createSupabaseClient();
    
    const { data: quizResult, error: insertError } = await supabase
      .from('quiz_results')
      .insert({
        email: email,
        name: name || email.split('@')[0],
        quiz_type: quizType,
        score: result.score,
        category: result.category,
        category_label: result.categoryLabel,
        risks: result.risks || [],
        recommendations: result.recommendations || [],
        answers: answers
        // âœ… created_at is auto-generated by database
      })
      .select()
      .single();
    
    if (insertError) {
      console.error('âŒ Supabase insert error:', insertError);
      throw new Error(`Database error: ${insertError.message}`);
    }
    
    console.log('âœ… Quiz results saved to Supabase:', quizResult.id);
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ·ï¸ ADD TO SMARTEMAILING LIST 4
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('ğŸ“¤ Adding to Smartemailing list 4 (kvÃ­z)...');
    
    try {
      const seApiKey = process.env.SMARTEMAILING_API_KEY;
      const seUsername = process.env.SMARTEMAILING_USERNAME;
      const seListId = process.env.SMARTEMAILING_LIST_KVIZ || '4'; // âœ… LIST 4 FOR QUIZ
      
      console.log('ğŸ”‘ SmartEmailing credentials:', {
        hasUsername: !!seUsername,
        hasApiKey: !!seApiKey,
        listId: seListId
      });
      
      if (!seApiKey || !seUsername) {
        console.warn('âš ï¸ Missing SmartEmailing credentials - skipping');
      } else {
        const seAuthString = Buffer.from(`${seUsername}:${seApiKey}`).toString('base64');
        
        // âœ… USE SAME PATTERN AS PAYMENT WEBHOOK
        const seResponse = await fetch('https://app.smartemailing.cz/api/v3/import', {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${seAuthString}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            settings: {
              update: true, // Update existing contacts
              field_policy: 'FILL_IN_EMPTY'
            },
            data: [{
              emailaddress: email,
              name: name || '',
              surname: '',
              contactlists: [{
                id: parseInt(seListId), // âœ… LIST 4
                status: 'confirmed'
              }]
              // âŒ REMOVED: customfields - need to configure correct IDs first
              // TODO: Add custom fields after checking SmartEmailing dashboard for correct IDs
            }]
          })
        });
        
        const seData = await seResponse.json();
        console.log('ğŸ“¥ SmartEmailing response:', seData);
        
        const successStatuses = ['ok', 'created'];
        if (seResponse.ok && successStatuses.includes(seData.status)) {
          console.log('âœ… Added to Smartemailing:', seData.status);
        } else {
          console.error('âš ï¸ SmartEmailing failed:', seData);
        }
      }
    } catch (seError) {
      console.error('âš ï¸ SmartEmailing error (non-critical):', seError.message);
      // Don't fail the whole function if SE fails
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ğŸ“§ SEND EMAIL WITH RESULTS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    console.log('ğŸ“¨ Sending quiz results email...');
    
    const emailHtml = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f3f4f6; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
  <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="background-color: #f3f4f6;">
    <tr>
      <td align="center" style="padding: 40px 20px;">
        <table role="presentation" width="600" cellspacing="0" cellpadding="0" border="0" style="max-width: 600px; background-color: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
          
          <!-- Header -->
          <tr>
            <td style="background: linear-gradient(135deg, #dc2626 0%, #15803d 100%); padding: 40px 20px; text-align: center;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 700;">
                ğŸ Tvoje vÃ½sledky jsou tady!
              </h1>
            </td>
          </tr>
          
          <!-- Content -->
          <tr>
            <td style="padding: 40px 30px;">
              <p style="margin: 0 0 20px 0; color: #111827; font-size: 18px; line-height: 1.6;">
                Ahoj <strong>${name || 'podnikateli'}</strong>! ğŸ‘‹
              </p>
              
              <p style="margin: 0 0 20px 0; color: #374151; font-size: 16px; line-height: 1.6;">
                TvÅ¯j byznys mÃ¡ skÃ³re <strong style="color: #dc2626; font-size: 24px;">${result.score}%</strong>
              </p>
              
              <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; padding: 20px; margin: 20px 0; border-left: 4px solid #f59e0b;">
                <p style="margin: 0 0 10px 0; font-weight: 700; color: #92400e; font-size: 18px;">
                  ğŸ“Š Tvoje kategorie: ${result.categoryLabel}
                </p>
                <p style="margin: 0; font-size: 14px; color: #78350f; line-height: 1.5;">
                  ${result.categoryDescription}
                </p>
              </div>
              
              ${result.risks && result.risks.length > 0 ? `
              <div style="margin: 30px 0;">
                <h2 style="color: #dc2626; font-size: 20px; margin: 0 0 15px 0;">âš ï¸ Na co si dÃ¡t pozor:</h2>
                <ul style="margin: 0; padding-left: 20px; color: #374151;">
                  ${result.risks.map(risk => `<li style="margin-bottom: 8px;">${risk}</li>`).join('')}
                </ul>
              </div>
              ` : ''}
              
              ${result.recommendations && result.recommendations.length > 0 ? `
              <div style="margin: 30px 0;">
                <h2 style="color: #15803d; font-size: 20px; margin: 0 0 15px 0;">âœ… Co dÄ›lat PRVNÃ:</h2>
                <ul style="margin: 0; padding-left: 20px; color: #374151;">
                  ${result.recommendations.map(rec => `<li style="margin-bottom: 8px;">${rec}</li>`).join('')}
                </ul>
              </div>
              ` : ''}
              
              <!-- CTA Button -->
              <table role="presentation" width="100%" cellspacing="0" cellpadding="0" border="0" style="margin: 30px 0;">
                <tr>
                  <td align="center">
                    <a href="https://podnikatelskactvrtka.cz/kviz/vysledky?email=${encodeURIComponent(email)}&score=${result.score}&category=${encodeURIComponent(result.category)}&name=${encodeURIComponent(name || email.split('@')[0])}&subScores=${encodeURIComponent(JSON.stringify(result.subScores || []))}" style="display: inline-block; background: linear-gradient(135deg, #dc2626 0%, #15803d 100%); color: #ffffff; text-decoration: none; padding: 16px 40px; border-radius: 8px; font-size: 18px; font-weight: 600; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.3);">
                      ğŸ„ Zobrazit kompletnÃ­ vÃ½sledky a akÄnÃ­ plÃ¡n
                    </a>
                  </td>
                </tr>
              </table>
              
              <p style="margin: 20px 0 0 0; color: #6b7280; font-size: 14px; line-height: 1.6;">
                PÅ™ejeme ti ÃºspÄ›Å¡nÃ½ rok 2026! ğŸš€<br>
                <strong>PodnikatelskÃ¡ ÄŒtvrtka</strong>
              </p>
            </td>
          </tr>
          
          <!-- Footer -->
          <tr>
            <td style="background-color: #f9fafb; padding: 30px; text-align: center; border-top: 1px solid #e5e7eb;">
              <p style="margin: 0; color: #6b7280; font-size: 14px;">
                PodnikatelskÃ¡ ÄŒtvrtka<br>
                <a href="https://podnikatelskactvrtka.cz" style="color: #dc2626; text-decoration: none;">podnikatelskactvrtka.cz</a>
              </p>
            </td>
          </tr>
          
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
    `;
    
    try {
      // âœ… UNIFIED EMAIL SUBJECT with emoji + category
      const emoji = result.category === 'beginner' ? 'ğŸŒ±' :
                    result.category === 'critical' ? 'ğŸ”´' :
                    result.category === 'unstable' ? 'ğŸŸ¡' :
                    result.category === 'solid' ? 'ğŸŸ¢' :
                    result.category === 'advanced' ? 'ğŸ’' : 'ğŸ¯';
      
      const categoryName = result.category === 'beginner' ? 'ZaÄÃ­nÃ¡Å¡' :
                           result.category === 'critical' ? 'KritickÃ½ stav' :
                           result.category === 'unstable' ? 'NestabilnÃ­' :
                           result.category === 'solid' ? 'SolidnÃ­ zÃ¡klad' :
                           result.category === 'advanced' ? 'PokroÄilÃ½' : 'VÃ½sledky';
      
      await sendEmail(
        email,
        `${emoji} ${categoryName} (${result.score}%) - TvÅ¯j model podnikÃ¡nÃ­`,
        emailHtml
      );
      console.log('âœ… Email sent successfully!');
    } catch (emailError) {
      console.error('âŒ Email send failed:', emailError);
      // Don't throw - quiz was saved, email is bonus
    }
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // âœ… SUCCESS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    return {
      statusCode: 200,
      headers,
      body: JSON.stringify({
        success: true,
        message: 'Quiz results saved and email sent',
        quizId: quizResult.id,
        score: result.score,
        category: result.category
      })
    };
    
  } catch (error) {
    console.error('âŒ Quiz submission error:', error);
    
    return {
      statusCode: 500,
      headers,
      body: JSON.stringify({
        error: error.message || 'Failed to submit quiz'
      })
    };
  }
}